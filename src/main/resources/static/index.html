<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Data Manager (å•†å“ç®¡ç†ç³»ç»Ÿ)</title>
    <!-- Bootstrap æ ·å¼ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ECharts å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .table-actions .btn { margin-right: 5px; }
        .search-box { max-width: 400px; }
        .pagination-info { margin: 0 15px; font-weight: bold; font-size: 0.9rem; color: #555; }
        /* å›¾è¡¨å®¹å™¨é«˜åº¦ */
        #priceChart { width: 100%; height: 400px; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">ğŸ“¦ Shop Data Manager (å•†å“ç®¡ç†ç³»ç»Ÿ)</h2>

    <!-- é¡¶éƒ¨æœç´¢æ  -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="input-group search-box">
            <input type="text" id="searchInput" class="form-control" placeholder="ğŸ” è¾“å…¥å•†å“åç§°æœç´¢...">
            <button class="btn btn-primary" onclick="searchProducts()">æœç´¢</button>
        </div>
    </div>

    <!-- 1. æ–°å¢/ç¼–è¾‘ è¡¨å• -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <span id="formTitle">â• æ–°å¢å•†å“</span>
        </div>
        <div class="card-body">
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">å•†å“åç§°</label>
                        <input type="text" class="form-control" id="productName" placeholder="ä¾‹å¦‚ï¼šæœºæ¢°é”®ç›˜" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ä»·æ ¼</label>
                        <input type="number" class="form-control" id="productPrice" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">æè¿°</label>
                        <input type="text" class="form-control" id="productDesc" placeholder="ç®€çŸ­æè¿°" required>
                    </div>
                </div>
                <div class="mt-3 text-end">
                    <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">é‡ç½®</button>
                    <button type="submit" class="btn btn-success" id="saveBtn">ä¿å­˜æäº¤</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. æ•°æ®è¡¨æ ¼ -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            ğŸ“‹ å•†å“åˆ—è¡¨
        </div>
        <div class="card-body">
            <table class="table table-hover table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>åç§°</th>
                        <th>ä»·æ ¼</th>
                        <th>æè¿°</th>
                        <th style="width: 150px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>

            <!-- åˆ†é¡µæ§ä»¶ -->
            <div class="d-flex justify-content-center align-items-center mt-3">
                <button class="btn btn-outline-primary btn-sm" id="prevBtn" onclick="changePage(-1)">â¬…ï¸ ä¸Šä¸€é¡µ</button>
                <span class="pagination-info" id="pageInfo">ç¬¬ 1 / 1 é¡µ</span>
                <button class="btn btn-outline-primary btn-sm" id="nextBtn" onclick="changePage(1)">ä¸‹ä¸€é¡µ â¡ï¸</button>
            </div>
        </div>
    </div>

    <!-- 3. ç»Ÿè®¡å›¾è¡¨ -->
    <div class="card">
        <div class="card-header bg-success text-white">
            ğŸ“Š å•†å“ä»·æ ¼ç»Ÿè®¡
        </div>
        <div class="card-body">
            <div id="priceChart"></div>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:9090/api/products';

    // åˆ†é¡µçŠ¶æ€
    let currentPage = 0;
    const pageSize = 5;
    let totalPages = 0;

    // åˆå§‹åŒ–ï¼šåŠ è½½åˆ—è¡¨å’Œå›¾è¡¨
    document.addEventListener('DOMContentLoaded', () => {
        loadProducts();
        loadChart();
    });

    // --- ECharts å›¾è¡¨æ¸²æŸ“ ---
    function loadChart() {
        fetch(`${API_URL}/all`)
            .then(res => res.json())
            .then(data => {
                const names = data.map(item => item.name);
                const prices = data.map(item => item.price);

                const chartDom = document.getElementById('priceChart');
                // é˜²æ­¢å¤šæ¬¡åˆå§‹åŒ–å¯¼è‡´è­¦å‘Šï¼Œå…ˆ dispose æˆ–è€…åˆ¤æ–­å±æ€§
                if (echarts.getInstanceByDom(chartDom)) {
                    echarts.getInstanceByDom(chartDom).dispose();
                }
                const myChart = echarts.init(chartDom);

                const option = {
                    tooltip: { trigger: 'axis' },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: {
                        type: 'category',
                        data: names,
                        axisLabel: { rotate: 30, interval: 0 }
                    },
                    yAxis: { type: 'value', name: 'ä»·æ ¼ (å…ƒ)' },
                    series: [{
                        data: prices,
                        type: 'bar',
                        itemStyle: { color: '#3b82f6' },
                        showBackground: true,
                        backgroundStyle: { color: 'rgba(180, 180, 180, 0.1)' },
                        label: { show: true, position: 'top' }
                    }]
                };
                myChart.setOption(option);
                window.onresize = function() { myChart.resize(); };
            });
    }

    // --- åˆ—è¡¨åŠ è½½ (å«åˆ†é¡µå’Œæœç´¢) ---
    function loadProducts() {
        const keyword = document.getElementById('searchInput').value;
        let url = `${API_URL}?page=${currentPage}&size=${pageSize}`;
        if (keyword) url += `&name=${encodeURIComponent(keyword)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('productTableBody');
                tbody.innerHTML = '';
                const products = data.content;
                totalPages = data.totalPages;

                document.getElementById('pageInfo').innerText = `ç¬¬ ${currentPage + 1} / ${totalPages || 1} é¡µ`;
                document.getElementById('prevBtn').disabled = data.first;
                document.getElementById('nextBtn').disabled = data.last;

                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“</td></tr>';
                    return;
                }

                products.forEach(product => {
                    const row = `
                        <tr>
                            <td>${product.id}</td>
                            <td>${product.name}</td>
                            <td>Â¥${product.price.toFixed(2)}</td>
                            <td>${product.description}</td>
                            <td class="table-actions">
                                <button class="btn btn-sm btn-warning text-white" onclick="editProduct(${product.id})">ç¼–è¾‘</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            })
            .catch(error => console.error('Error:', error));
    }

    // --- äº¤äº’é€»è¾‘ ---
    function searchProducts() {
        currentPage = 0;
        loadProducts();
    }

    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            loadProducts();
        }
    }

    // è¡¨å•æäº¤
    document.getElementById('productForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('productId').value;
        const product = {
            name: document.getElementById('productName').value,
            price: parseFloat(document.getElementById('productPrice').value),
            description: document.getElementById('productDesc').value
        };

        let method = 'POST';
        let url = API_URL;

        if (id) {
            method = 'PUT';
            url = `${API_URL}/${id}`;
        }

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(product)
        })
        .then(response => {
            if (response.ok) {
                loadProducts();
                loadChart(); // åˆ·æ–°å›¾è¡¨
                resetForm();
            } else {
                alert('ä¿å­˜å¤±è´¥');
            }
        });
    });

    // åˆ é™¤
    function deleteProduct(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤ ID ä¸º ' + id + ' çš„å•†å“å—ï¼Ÿ')) return;
        fetch(`${API_URL}/${id}`, { method: 'DELETE' })
        .then(response => {
            if (response.ok) {
                loadProducts();
                loadChart(); // åˆ·æ–°å›¾è¡¨
            }
        });
    }

    // ç¼–è¾‘å›å¡«
    function editProduct(id) {
        fetch(`${API_URL}/${id}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('productId').value = data.id;
                document.getElementById('productName').value = data.name;
                document.getElementById('productPrice').value = data.price;
                document.getElementById('productDesc').value = data.description;

                document.getElementById('formTitle').innerText = 'âœï¸ ä¿®æ”¹å•†å“ (ID: ' + id + ')';
                document.getElementById('saveBtn').className = 'btn btn-warning text-white';
                document.getElementById('saveBtn').innerText = 'ç¡®è®¤ä¿®æ”¹';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
    }

    function resetForm() {
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('formTitle').innerText = 'â• æ–°å¢å•†å“';
        document.getElementById('saveBtn').className = 'btn btn-success';
        document.getElementById('saveBtn').innerText = 'ä¿å­˜æäº¤';
    }
</script>

</body>
</html>