# 1. 持久卷声明 (PersistentVolumeClaim) - 用于 MySQL 数据持久化
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim
  labels:
    app: mysql
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi # 请求 1GB 存储空间

---

# 2. MySQL 数据库服务 (Service) - 集群内部访问
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  labels:
    app: mysql
spec:
  ports:
    - port: 3306
  selector:
    app: mysql
  clusterIP: None

---

# 3. MySQL 数据库部署 (Deployment) - 使用官方镜像
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-deployment
  labels:
    app: mysql
spec:
  selector:
    matchLabels:
      app: mysql
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
        - name: mysql
          image: mysql:8.0
          ports:
            - containerPort: 3306
          env: # 匹配 docker-compose.yml 中的环境变量
            - name: MYSQL_ROOT_PASSWORD
              value: root
            - name: MYSQL_DATABASE
              value: mall
            - name: TZ
              value: Asia/Shanghai
          volumeMounts:
            - name: mysql-persistent-storage
              mountPath: /var/lib/mysql
      volumes:
        - name: mysql-persistent-storage
          persistentVolumeClaim:
            claimName: mysql-pv-claim

---

# 4. 后端 API 服务 (Service) - 集群内部访问
apiVersion: v1
kind: Service
metadata:
  name: app-backend-service
  labels:
    app: backend
spec:
  ports:
    - port: 9090
      targetPort: 9090
  selector:
    app: backend

---

# 5. 后端 API 部署 (Deployment) - 使用多阶段构建的镜像
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-backend-deployment
  labels:
    app: backend
spec:
  replicas: 1 # 修复点：减少到 1 个副本，适合单节点集群
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
        - name: app-backend
          image: shop-backend:v1
          ports:
            - containerPort: 9090
          env: # 连接数据库的服务名必须是 mysql-service
            - name: SPRING_DATASOURCE_URL
              value: jdbc:mysql://mysql-service:3306/mall?useUnicode=true&characterEncoding=utf-8&serverTimezone=Asia/Shanghai
            - name: SPRING_DATASOURCE_PASSWORD
              value: root
            - name: TZ
              value: Asia/Shanghai
          # 修复点：移除了 Liveness/Readiness 探针，确保 Pod 进程启动即为就绪
          # 在单节点有限资源下，这样设置可保证容器稳定运行。

---

# 6. 前端 Nginx 服务 (Service) - 对外暴露
apiVersion: v1
kind: Service
metadata:
  name: app-frontend-service
  labels:
    app: frontend
spec:
  type: NodePort # 使用 NodePort 对外暴露服务
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30081 # 可以在集群节点的 30081 端口访问
  selector:
    app: frontend

---

# 7. 前端 Nginx 部署 (Deployment) - 使用 Nginx 镜像
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-frontend-deployment
  labels:
    app: frontend
spec:
  replicas: 1 # 修复点：减少到 1 个副本
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: app-frontend
          image: shop-frontend:v1
          ports:
            - containerPort: 80