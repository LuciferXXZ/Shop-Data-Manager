# ==========================================
# 1. MySQL æ•°æ®åº“å±‚
# ==========================================

# PVC: æ•°æ®æŒä¹…åŒ–
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim
  labels:
    app: mysql
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi

---
# ConfigMap: å­˜æ”¾åˆå§‹åŒ– SQL è„šæœ¬ (âœ… æ–°å¢åŠŸèƒ½ï¼šè‡ªåŠ¨åˆå§‹åŒ–)
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-initdb-config
data:
  init.sql: |
    -- åˆ‡æ¢åˆ° mall æ•°æ®åº“
    SET NAMES utf8mb4;
    USE mall;

    -- åˆ›å»ºå•†å“è¡¨
    CREATE TABLE IF NOT EXISTS product (
                                           id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ä¸»é”®ID',
                                           name VARCHAR(100) NOT NULL COMMENT 'å•†å“åç§°',
        price DECIMAL(10, 2) NOT NULL COMMENT 'å•†å“ä»·æ ¼',
        description VARCHAR(255) COMMENT 'å•†å“æè¿°',
        create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
        update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´'
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

    -- æ’å…¥å‡ æ¡æµ‹è¯•æ•°æ®
    INSERT INTO product (name, price, description) VALUES
                                                       ('Dockerå…¥é—¨æ•™ç¨‹', 59.90, 'æ·±å…¥æµ…å‡ºå­¦ä¹ å®¹å™¨æŠ€æœ¯'),
                                                       ('Spring Bootå®æˆ˜', 89.00, 'Javaåç«¯å¼€å‘å¿…è¯»'),
                                                       ('æœºæ¢°é”®ç›˜', 299.00, 'ç¨‹åºå‘˜ç¼–ç ç¥å™¨');

---
# MySQL Service
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  labels:
    app: mysql
spec:
  ports:
    - port: 3306
  selector:
    app: mysql
  clusterIP: None

---
# MySQL Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-deployment
  labels:
    app: mysql
spec:
  selector:
    matchLabels:
      app: mysql
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
        - name: mysql
          image: mysql:8.0
          ports:
            - containerPort: 3306
          env:
            - name: MYSQL_ROOT_PASSWORD
              value: root
            - name: MYSQL_DATABASE
              value: mall
            - name: TZ
              value: Asia/Shanghai
          volumeMounts:
            - name: mysql-persistent-storage
              mountPath: /var/lib/mysql
            # âœ… å°† ConfigMap æŒ‚è½½åˆ°å®¹å™¨çš„åˆå§‹åŒ–ç›®å½•
            - name: mysql-initdb
              mountPath: /docker-entrypoint-initdb.d
      volumes:
        - name: mysql-persistent-storage
          persistentVolumeClaim:
            claimName: mysql-pv-claim
        # âœ… å®šä¹‰ ConfigMap å·
        - name: mysql-initdb
          configMap:
            name: mysql-initdb-config

---

# ==========================================
# 2. åç«¯ API æœåŠ¡ (æ”¯æŒè“ç»¿éƒ¨ç½²)
# ==========================================

# åç«¯ Serviceï¼šä½œä¸ºæµé‡å…¥å£
apiVersion: v1
kind: Service
metadata:
  name: app-backend  # âœ… ä¿®å¤ï¼šåç§°å¿…é¡»æ˜¯ app-backendï¼Œä¸ Nginx é…ç½®ä¸€è‡´
  labels:
    app: backend
spec:
  ports:
    - port: 9090
      targetPort: 9090
  selector:
    app: backend
    # âš ï¸ æ ¸å¿ƒæ§åˆ¶ç‚¹ï¼šä¿®æ”¹è¿™é‡Œçš„ color æ¥åˆ‡æ¢æµé‡ (blue <-> green)
    color: blue

---

# ğŸ”µ è“è‰²ç¯å¢ƒ (V1 - å½“å‰åœ¨çº¿)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-backend-blue
  labels:
    app: backend
    color: blue
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
      color: blue
  template:
    metadata:
      labels:
        app: backend
        color: blue
    spec:
      containers:
        - name: app-backend
          image: shop-backend:v1
          ports:
            - containerPort: 9090
          env:
            - name: SPRING_DATASOURCE_URL
              value: jdbc:mysql://mysql-service:3306/mall?useUnicode=true&characterEncoding=utf-8&serverTimezone=Asia/Shanghai
            - name: SPRING_DATASOURCE_PASSWORD
              value: root
            - name: TZ
              value: Asia/Shanghai

---

# ğŸŸ¢ ç»¿è‰²ç¯å¢ƒ (V2 - å¾…å‘å¸ƒ)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-backend-green
  labels:
    app: backend
    color: green
spec:
  replicas: 0 # åˆå§‹ä¸è¿è¡Œï¼Œæ¼”ç¤ºéƒ¨ç½²æ—¶æ”¹ä¸º 1
  selector:
    matchLabels:
      app: backend
      color: green
  template:
    metadata:
      labels:
        app: backend
        color: green
    spec:
      containers:
        - name: app-backend
          image: shop-backend:v1
          ports:
            - containerPort: 9090
          env:
            - name: SPRING_DATASOURCE_URL
              value: jdbc:mysql://mysql-service:3306/mall?useUnicode=true&characterEncoding=utf-8&serverTimezone=Asia/Shanghai
            - name: SPRING_DATASOURCE_PASSWORD
              value: root
            - name: TZ
              value: Asia/Shanghai

---

# ==========================================
# 3. å‰ç«¯ Nginx æœåŠ¡
# ==========================================
apiVersion: v1
kind: Service
metadata:
  name: app-frontend-service
  labels:
    app: frontend
spec:
  type: NodePort
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30081
  selector:
    app: frontend

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-frontend-deployment
  labels:
    app: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: app-frontend
          image: shop-frontend:v1
          ports:
            - containerPort: 80